# Read more about containers on our dev center
# http://devcenter.wercker.com/docs/containers/index.html
box: node:6.3
# This is the build pipeline. Pipelines are the core of wercker
# Read more about pipelines on our dev center
# http://devcenter.wercker.com/docs/pipelines/index.html

build:
  # Read more about steps on our dev center:
  # http://devcenter.wercker.com/docs/steps/index.html
  steps:
    - script:
      name: Set Timezone
      code: |
        export TZ="Asia/Tokyo"

    # Install packages
    - npm-install

    # Check node versions if needed
    - script:
        name: echo nodejs information
        code: |
          echo "node version $(node -v) running"
          echo "npm version $(npm -v) running"

    # Check coverage
    # TODO: Setup codecov for repo
    #- script:
    #  name: npm install codecov
    #  code: |
    #     npm install -g jshint codecov to-iso-string
    #     npm install --unsafe-perm
    #- maxon/npm-run:
    #  name: codecov
    #  script: codecov

    - script:
        name: npm run lint
        code: |
          npm run lint

    - script:
      name: npm install flow-bin
      code: |
         npm install flow-bin@0.27.0

    - script:
        name: npm run flow
        code: |
          npm run flow

    # A step to run Unit tests
    - npm-test

    # A step to check code coverage (90%)
    - script:
        name: npm run coverage
        code: |
          [[ $(npm run coverage 2&>1 | grep "All files" | awk '{print $4}') > 90 ]] || \
          { echo "Bad coverage, please run 'npm run coverage'"; exit 1; }


  after-steps:
    - script:
      code: |
        env
    - sherzberg/slack-notify:
      subdomain: share-wis
      token: $SLACK_TOKEN
      channel: "#notifications-ci"
      username: "ShareWis ACT Mobile on Wercker"
